<!DOCTYPE html>
<html>
<head>
    <title>User Story Ancestor Grid</title>
    <!--  (c) 2016 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue May 02 2017 12:55:31 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue May 02 2017 12:55:31 GMT-0600 (MDT)";
        var BUILDER = "corkr03";
        var CHECKSUM = 46994270246;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Rally.ui.dialog.Dialog',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
    title: "Build Information",
    
    defaults: { padding: 5, margin: 5 },

    closable: true,
     
    draggable: true,

    autoShow: true,
   
    width: 350,
    
    informationalConfig: null,
    
    items: [{xtype:'container', itemId:'information' }],
    
    initComponent: function() {
        var id = Ext.id(this);
        this.title =  "<span class='icon-help'> </span>" + this.title;
        this.callParent(arguments);
    },
    
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/var BUILDER = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
       
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
   
        return chk;
    },
    
    _checkChecksum: function(container) {
        var deferred = Ext.create('Deft.Deferred');
        var me = this;
        
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    var stored_checksum = me._generateChecksum(text);
                    if ( CHECKSUM !== stored_checksum ) {
                        deferred.resolve(false);
                        return;
                    }
                }
                deferred.resolve(true);
            }
        });
        
        return deferred.promise;
    },
    
    _addToContainer: function(container){
        var config = Ext.apply({
            xtype:'container',
            height: 200,
            overflowY: true
        }, this.informationalConfig);
        
        container.add(config);
    },
    
    afterRender: function() {
        var app = Rally.getApp();
        
        if ( !Ext.isEmpty( this.informationalConfig ) ) {
            var container = this.down('#information');
            this._addToContainer(container);
            
        }
        
        if (! app.isExternal() ) {
            this._checkChecksum(app).then({
                scope: this,
                success: function(result){
                    if ( !result ) {
                        this.addDocked({
                            xtype:'container',
                            cls: 'build-info',
                            dock: 'bottom',
                            padding: 2,
                            html:'<span class="icon-warning"> </span>Checksums do not match'
                        });
                    }
                },
                failure: function(msg){
                    console.log("oops:",msg);
                }
            });
        } else {
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html:'... Running externally'
            });
        }
        this.callParent(arguments);
    },
    
    beforeRender: function() {
        var me = this;
        this.callParent(arguments);

        if (this.informationHtml) {
            this.addDocked({
                xtype: 'component',
                componentCls: 'intro-panel',
                padding: 2,
                html: this.informationHtml,
                doc: 'top'
            });
        }
        
        this.addDocked({
            xtype:'container',
            cls: 'build-info',
            padding: 2,
            dock:'bottom',
            html:"This app was created by the CA AC Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html: Ext.String.format("Build date/time: {0} ({1})",
                    APP_BUILD_DATE,
                    BUILDER)
            });
        }
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

    Ext.define('RallyTechServices.inlinefilter.AncestorFilterRow', {
        alias: 'widget.rallyancestorfilterrow',
        extend: 'Rally.ui.inlinefilter.AdvancedFilterRow',

        layout: 'hbox',
        bubbleEvents: ['filterchange'],
        cls: 'advanced-filter-row',
        flex: 2,

        config: {
            context: undefined,
            model: undefined,
            autoExpand: false,
            name: undefined,
            operator: undefined,
            rawValue: undefined,
            addButtonEnabled: false,
            removeButtonEnabled: false,
            ancestorFieldConfig: {},
            propertyFieldConfig: {},
            operatorFieldConfig: {},
            focusPropertyField: false
        },

        isValid: function() {
            return this._hasPropertySelected() && this._hasOperatorSelected() && this._valueFieldIsValid();
        },
        _getFeatureName: function(){
            if (!this.featureName){
                var records = this.ancestorField && this.ancestorField.getStore() && this.ancestorField.getStore().getRange();
                Ext.Array.each(records, function(r){
                    if (r.get('Ordinal') === 0){
                        var typePath = r.get('TypePath');
                        this.featureName = typePath.replace('PortfolioItem/','');
                    }
                }, this);
            }
            return this.featureName;
        },
        getFilter: function() {
            if (this.isValid()) {
                var ancestorRecord = this.ancestorField.getRecord(),
                    property = this.propertyField.lastValue,
                    operator = this.operatorField.lastValue,
                    valueField = this.valueField;

                var lastValue = Ext.isEmpty(valueField.lastValue) ? null : valueField.lastValue;

                var isRefUri = Rally.util.Ref.isRefUri(lastValue);
                var isRefOid = _.isNumber(Rally.util.Ref.getOidFromRef(lastValue));
                if (isRefUri && isRefOid && valueField.valueField === '_ref' && valueField.noEntryValue !== lastValue) {
                    var record = valueField.getRecord();
                    if (record) {
                        var uuidRef = record.get('_uuidRef');
                        if (uuidRef) {
                            lastValue = uuidRef;
                        }
                    }
                }

                if (ancestorRecord && ancestorRecord.get('TypePath')){
                    var ordinal = ancestorRecord.get('Ordinal');
                    var propertyPrefix = [this._getFeatureName()];

                    if (ordinal === 0){
                        propertyPrefix.push(property);
                    } else {
                        for (var i=0; i<ordinal; i++){
                            propertyPrefix.push('Parent');
                        }
                        propertyPrefix.push(property);
                    }
                    property = propertyPrefix.join('.');
                }

                var filter = Rally.data.wsapi.Filter.fromExtFilter({
                    property: property,
                    operator: operator,
                    value: lastValue
                });

                if (valueField.allowNoEntry && valueField.noEntryValue === lastValue) {
                    filter.value = null;
                }

                Ext.apply(filter, {
                    name: property,
                    rawValue: lastValue,
                    filterIndex: this.filterIndex
                });

                return filter;
            }
        },

        _fixPropertyFieldInIE: function() {
            if (Ext.isIE10m && this.propertyField.inputEl) {
                this.propertyField.setValue(this.propertyField.getValue());
            }
        },
        _onTypeAncestorStoreLoad: function(store, records){

            var ancestor = this.name && this.name.split(".");
            var idx = undefined,
                thisVal = null;

            if (ancestor.length > 1){
                idx = ancestor.length - 2;
            }

            Ext.Array.each(records, function(r){
               if (r.get('Ordinal') === 0){
                   var typePath = r.get('TypePath');
                   this.featureName = typePath.replace('PortfolioItem/','');
               }

                if (idx === r.get('Ordinal')){
                    thisVal = r.get('TypePath');
                    return false;
                }

           }, this);

           if (thisVal){
               this.name = ancestor.slice(-1)[0];
               this.ancestorField.setValue(thisVal);

               this.originalName = this.name;
               this.originalOperator = this.operator;
               this.originalValue = this.rawValue;

               this._onAncestorSelect(this.ancestorField);
           }

        },
        _createAncestorField: function(){

            this.ancestorField = Ext.widget(Ext.merge({
                xtype: 'rallycombobox',
                itemId: 'ancestorField',
                autoExpand: this.autoExpand,
                storeConfig: {
                    model: 'TypeDefinition',
                    fetch: ['TypePath','DisplayName','Ordinal','Name'],
                    filters: [{
                        property: 'TypePath',
                        operator: 'contains',
                        value: 'PortfolioItem/'
                    }],
                    autoLoad: true,
                    listeners: {
                        load: this._onTypeAncestorStoreLoad,
                        scope: this
                    },
                    remoteFilter: true
                },
                allowNoEntry: true,
                cls: 'indexed-field property-field',
                width: 100,
                labelAlign: 'top',
                fieldLabel: 'OBJECT',
                valueField: 'TypePath',
                displayField: 'Name',
                labelSeparator: '',
                noEntryText: 'User Story',
                listeners: {
                    select: this._onAncestorSelect,
                    scope: this
                }
            }, this.ancestorFieldConfig));
        },

        _createIndexLabel: function() {
            this.indexLabel = Ext.widget({
                xtype: 'label',
                itemId: 'indexLabel',
                cls: 'index-label',
                hidden: true,
                listeners: {
                    el: {
                        click: function () {
                            this.propertyField.expand();
                        },
                        scope: this
                    },
                    afterrender: {
                        fn: function() {
                            this.indexLabel.el.show();
                        },
                        scope: this,
                        single: true
                    }
                },
                text: this._getFilterIndexText(this.filterIndex)
            });
        },

        _getItems: function() {
            this._createAddRowButton();
            this._createRemoveRowButton();
            this._createIndexLabel();
            this._createAncestorField();
            this._createPropertyField();
            this._createOperatorField();
            this._createValueField();

            return [
                this.addRowButton,
                this.removeRowButton,
                this.indexLabel,
                this.ancestorField,
                this.propertyField,
                this.operatorField,
                this.valueField
            ];
        },

        _hasAncestorSelected: function() {
            return !!this.ancestorField.getValue();
        },

        _replacePropertyField: function() {
            var deferred = new Deft.Deferred();

            this.name = this.originalName || undefined;
            this.propertyField.destroy();
            this._createPropertyField();
            this.propertyField.store.on('load', function() {
                deferred.resolve();
            });
            this.add(this.propertyField);
            return deferred.promise;
        },

        _replaceOperatorField: function() {
            var deferred = new Deft.Deferred();
            delete this.operator;
            this.operatorField.destroy();
            this._createOperatorField();
            this.operatorField.store.on('load', function() {
                if (this.originalOperator){ //set this so that filters update
                    this.operatorField.setValue(this.originalOperator);
                    this._applyFilters();
                    delete this.originalOperator;
                }
                deferred.resolve();
            }, this);

            this.add(this.operatorField);
            return deferred.promise;
        },

        _replaceValueField: function() {
            delete this.rawValue;
            this.rawValue = this.originalValue || undefined;
            delete this.originalValue;

            this.valueField.destroy();
            this._createValueField();
            this.add(this.valueField);
            return Deft.Promise.when();
        },
        _onAncestorSelect: function() {

            var type = this.ancestorField.getValue() || 'HierarchicalRequirement';
            Rally.data.ModelFactory.getModel({
                type: type,
                success: function(model) {
                    this.model = model;

                    if (this.name){
                        var names = this.name.split('.');
                        this.name = names.slice(-1)[0];
                    }

                    Deft.Promise.all([
                        this._replacePropertyField(),
                        this._replaceOperatorField(),
                        this._replaceValueField()
                    ]).then({
                        success: function() {
                            //We only want to do this once
                            delete this.originalName;
                            delete this.originalOperator;
                            delete this.originalValue;

                            this._applyFilters();
                            this.propertyField.focus(false, 200);
                        },
                        scope: this
                    });
                },
                scope: this
            });
        }
    });

Ext.define('CArABU.technicalservices.AncestorTemplateColumn', {
    extend: 'Ext.grid.column.Template',
    alias: ['widget.ancestortemplatecolumn'],

    align: 'right',

    initComponent: function(){
        var me = this;

        me.tpl = new Ext.XTemplate('<tpl><div style="text-align:right;">{[this.getAncestorString(values)]}</div></tpl>',{
            ancestorName: me.ancestorName,

            getAncestorString: function(values){
                if (values.FormattedID){
                    return Ext.String.format("<a href=\"{0}\" target=\"blank\">{1}</a>: {2}",Rally.util.Navigation.getDetailUrl(values), values.FormattedID, values.Name);
                }
                return '';
            }

        });
        me.hasCustomRenderer = true;
        me.callParent(arguments);
    },
    getValue: function(){
        return values[this.dataIndex] || 0;
    },
    defaultRenderer: function(value, meta, record) {
        var data = Ext.apply({}, record.get(this.ancestorName)); //, record.getAssociatedData());
        return this.tpl.apply(data);
    }
});
Ext.define('CArABU.technicalservices.FileUtilities',{
    singleton: true,
    saveCSVToFile:function(csv,file_name,type_object){
        if (type_object === undefined){
            type_object = {type:'text/csv;charset=utf-8'};
        }
        this.saveAs(csv,file_name, type_object);
    },
    saveAs: function(textToWrite, fileName)
    {
        if (Ext.isIE9m){
            Rally.ui.notify.Notifier.showWarning({message: "Export is not supported for IE9 and below."});
            return;
        }

        var textFileAsBlob = null;
        try {
            textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
        }
        catch(e){
            window.BlobBuilder = window.BlobBuilder ||
                window.WebKitBlobBuilder ||
                window.MozBlobBuilder ||
                window.MSBlobBuilder;
            if (window.BlobBuilder && e.name === 'TypeError'){
                bb = new BlobBuilder();
                bb.append([textToWrite]);
                textFileAsBlob = bb.getBlob("text/plain");
            }

        }

        if (!textFileAsBlob){
            Rally.ui.notify.Notifier.showWarning({message: "Export is not supported for this browser."});
            return;
        }

        var fileNameToSaveAs = fileName;

        if (Ext.isIE10p){
            window.navigator.msSaveOrOpenBlob(textFileAsBlob,fileNameToSaveAs); // Now the user will have the option of clicking the Save button and the Open button.
            return;
        }

        var url = this.createObjectURL(textFileAsBlob);

        if (url){
            var downloadLink = document.createElement("a");
            if ("download" in downloadLink){
                downloadLink.download = fileNameToSaveAs;
            } else {
                //Open the file in a new tab
                downloadLink.target = "_blank";
            }

            downloadLink.innerHTML = "Download File";
            downloadLink.href = url;
            if (!Ext.isChrome){
                // Firefox requires the link to be added to the DOM
                // before it can be clicked.
                downloadLink.onclick = this.destroyClickedElement;
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
            }
            downloadLink.click();
        } else {
            Rally.ui.notify.Notifier.showError({message: "Export is not supported "});
        }
    },
    createObjectURL: function ( file ) {
        if ( window.webkitURL ) {
            return window.webkitURL.createObjectURL( file );
        } else if ( window.URL && window.URL.createObjectURL ) {
            return window.URL.createObjectURL( file );
        } else {
            return null;
        }
    },
    destroyClickedElement: function(event)
    {
        document.body.removeChild(event.target);
    }
});


Ext.override(Rally.ui.inlinefilter.InlineFilterPanel, {
        minHeight: 46,
        padding: '8px 0 0 0',
        bodyPadding: '7px 5px 5px 5px',
        collapseDirection: 'top',
        collapsible: true,
        animCollapse: false,

        config: {
            inline: true,
            collapsed: true,
            anchorTargetCmp: undefined,
            model: undefined,
            context: undefined,
            quickFilterPanelConfig: {
                initialFilters: []
            },
            advancedFilterPanelConfig: {
                advancedFilterRowsConfig: {},
                matchTypeConfig: {
                    value: 'AND'
                }
            }
        },

        getAdvancedCollapsed: function() {
            return !!this.advancedFilterPanel.collapsed;
        },

        getTypes: function() {
            return this.quickFilterPanel.getTypes();
        },

        getTypesFilter: function() {
            return this.quickFilterPanel.getTypesFilter();
        },

        getFilters: function() {
            return [].concat(this.getQuickFilters()).concat(this.getAdvancedFilters());
        },

        getQuickFilters: function() {
            return this.quickFilterPanel.getFilters();
        },

        getAdvancedFilters: function() {
            return this.advancedFilterPanel.getFilters();
        },

        getCustomFilterCondition: function() {
            return this.advancedFilterPanel.getCustomFilterCondition();
        },

        getMatchType: function() {
            return this.advancedFilterPanel.getMatchType();
        },

        onDestroy: function() {
            _.invoke(_.compact([
                this.chevronAligner,
                this.toggleAdvancedButtonRelayedEvents
            ]), 'destroy');
            this.callParent(arguments);
        },

        onResize: function(width, height, oldWidth, oldHeight) {
            this.callParent(arguments);
            this._alignChevron();
            this.fireEvent('inlinefilterresize', this, height, oldHeight);
        },

        afterRender: function() {
            this.callParent(arguments);
            this.on('afterfilterchange', this._alignChevron, this);
        },

        validateCustomFilterCondition: function() {
            return this.advancedFilterPanel.validateCustomFilterCondition();
        },

        _onExpand: function(cmp) {
            if (cmp === this) {
                this.quickFilterPanel.focusFirstField();
            }
        },

        _onBeforeCollapse: function(cmp) {
            this._removeInvalidFilters();
            if (Ext.isIE10m && cmp === this) {
                this.focus();
            }
        },

        _removeInvalidFilters: function() {
            this.advancedFilterPanel.removeInvalidRows();
            this.quickFilterPanel.clearInvalidFields();
        },

        _getItems: function() {
            this._createCloseButton();
            this._createQuickFilterPanel();
            this._createAdvancedFilterPanel();
            this.toggleAdvancedButtonRelayedEvents = this.quickFilterPanel.toggleAdvancedButton.relayEvents(this.advancedFilterPanel, ['collapse', 'expand', 'filterchange'], 'advanced');

            return [
                this.closeButton,
                this.quickFilterPanel,
                this.advancedFilterPanel
            ];
        },

        _createCloseButton: function() {
            this.closeButton = Ext.widget({
                xtype: 'rallybutton',
                cls: 'inline-filter-panel-close icon-cross',
                height: 18,
                userAction: 'Close (X) filter panel clicked',
                listeners: {
                    click: function() {
                        this.collapse();
                    },
                    scope: this
                }
            });
        },

        _createQuickFilterPanel: function() {
            this.quickFilterPanel = Ext.widget(Ext.merge({
                xtype: 'rallyquickfilterpanel',
                autoExpand: !Ext.isIE,
                model: this.model,
                context: this.context,
                toggleAdvancedButtonConfig: {
                    advancedCollapsed: this.advancedFilterPanelConfig.collapsed
                },
                listeners: {
                    toggleadvanced: this._onToggleAdvanced,
                    quickfilterchange: this._onQuickFilterChange,
                    scope: this
                }
            }, this.quickFilterPanelConfig));
        },

        _createAdvancedFilterPanel: function() {
            var filterStartIndex = this._getFilterStartIndex(),
                matchTypeConfig = this.advancedFilterPanelConfig.matchTypeConfig,
                isMatchTypeCustom = matchTypeConfig.value === 'CUSTOM';

            this.advancedFilterPanel = Ext.widget(Ext.merge({
                xtype: 'rallyadvancedfilterpanel',
                customFilterConditionConfig: {
                    hidden: !isMatchTypeCustom,
                    maxWidth: 753,
                    width: '50%',
                    padding: '0 0 0 47px'
                },
                advancedFilterRowsConfig: {
                    autoExpand: !Ext.isIE,
                    model: this.model,
                    context: this.context,
                    filterStartIndex: filterStartIndex,
                    maxWidth: 800,
                    width: '50%',
                    padding: 0
                },
                matchTypeConfig: {
                    autoExpand: !Ext.isIE
                },
                listeners: {
                    matchtypechange: this._onMatchTypeChange,
                    scope: this
                }
            }, this.advancedFilterPanelConfig));
        },

        _getFilterStartIndex: function() {
            return this.quickFilterPanel.fields.length + 1;
        },

        _onToggleAdvanced: function(button) {
            this.advancedFilterPanel.toggleCollapse();
            if (Ext.isIE || Ext.isGecko) {
                button.focus();
            }
        },

        _alignChevron: function() {
            this._ensureChevron();
            if (!this.collapsed && this.anchorTargetCmp.el) {
                this.chevron.alignTo(this.anchorTargetCmp.el, 't-b', [0, 4]);
                this.chevron.show();
                this.chevronAligner.start();
            } else {
                this.chevron.hide();
                this.chevronAligner.stop();
            }
        },

        _ensureChevron: function() {
            if (!this.chevron && this.el) {
                this.chevron = this.el.createChild({
                    cls: 'chevron-up inline-filter-chevron'
                });

                this.chevronAligner = Ext.TaskManager.newTask({
                    run: function() {
                        if (!this.collapsed && this.anchorTargetCmp.el) {
                            var x = this.anchorTargetCmp.el.getX();
                            if (x !== this.lastX) {
                                this.lastX = x;
                                this._alignChevron();
                            }
                        }
                    },
                    scope: this,
                    interval: 250
                });
            }
        },

        _onMatchTypeChange: function(matchType) {
            this.quickFilterPanel.updateFilterIndices(matchType.getValue());
        },

        clear: function() {
            this.suspendEvents(false);
            this.suspendLayouts();
            this.quickFilterPanel.clear();
            this.advancedFilterPanel.clear();
            this.resumeEvents();
            this.resumeLayouts(false);
            this.updateLayout();
            this.fireEvent('filterchange', this);
        },

        _onQuickFilterChange: function() {
            this.quickFilterPanel.updateFilterIndices();
            this.advancedFilterPanel.updateFilterIndices(this._getFilterStartIndex());
            this.fireEvent('filterchange', this);
        }
    });
Ext.override(Rally.ui.grid.TreeGrid, {
    _mergeColumnConfigs: function(newColumns, oldColumns) {

        var mergedColumns= _.map(newColumns, function(newColumn) {
            var oldColumn = _.find(oldColumns, {dataIndex: this._getColumnName(newColumn)});
            if (oldColumn) {
                return this._getColumnConfigFromColumn(oldColumn);
            }

            return newColumn;
        }, this);
        mergedColumns = mergedColumns.concat(this.config.derivedColumns);
        return mergedColumns;
    },
    _getColumnConfigsBasedOnCurrentOrder: function(columnConfigs) {
        return _(this.headerCt.items.getRange()).map(function(column) {
            //override:  Added additional search for column.text
            return _.contains(columnConfigs, column.dataIndex) ? column.dataIndex : _.find(columnConfigs, {dataIndex: column.dataIndex, text: column.text});
        }).compact().value();
    },
    _restoreColumnOrder: function(columnConfigs) {

        var currentColumns = this._getColumnConfigsBasedOnCurrentOrder(columnConfigs);
        var addedColumns = _.filter(columnConfigs, function(config) {
            return !_.find(currentColumns, {dataIndex: config.dataIndex}) || Ext.isString(config);
        });

        return currentColumns.concat(addedColumns);
    },
    _applyStatefulColumns: function(columns) {
        if (this.alwaysShowDefaultColumns) {
            _.each(this.columnCfgs, function(columnCfg) {
                if (!_.any(columns, {dataIndex: this._getColumnName(columnCfg)})) {
                    columns.push(columnCfg);
                }
            }, this);
        }
        if (this.config && this.config.derivedColumns){
            this.columnCfgs = columns.concat(this.config.derivedColumns);
        } else {
            this.columnCfgs = columns;
        }
    }
});

Ext.override(Rally.ui.inlinefilter.AdvancedFilterRows, {
    _getRowConfig: function() {
        return Ext.merge({
            xtype: 'rallyancestorfilterrow',
            autoExpand: this.autoExpand,
            model: this.model,
            context: this.context,
            focusPropertyField: false,
            operatorFieldConfig: this.operatorFieldConfig,
            propertyFieldConfig: this.propertyFieldConfig,
            listeners: {
                addrow: function() {
                    this._addRow(true);
                },
                removerow: this._removeRow,
                scope: this
            }
        }, this.rowConfig);
    }
});

Ext.define("user-story-ancestor-grid", {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    defaults: { margin: 10 },

    integrationHeaders : {
        name : "user-story-ancestor-grid"
    },

    config: {
        defaultSettings: {
            query: ''
        }
    },

    launch: function() {
        this.fetchPortfolioItemTypes().then({
            success: this.initializeApp,
            failure: this.showErrorNotification,
            scope: this
        });

    },
    showErrorNotification: function(msg){
        Rally.ui.notify.Notifier.showError({
            message: msg
        });
    },
    initializeApp: function(portfolioTypes){
        this.portfolioItemTypeDefs = Ext.Array.map(portfolioTypes, function(p){ return p.getData();});
        this._buildGridboardStore();
    },
    getFeatureName: function(){
        return this.getFeatureTypePath().replace('PortfolioItem/','');
    },
    getFeatureTypePath: function(){
        return this.portfolioItemTypeDefs[0].TypePath;
        //return 'PortfolioItem/Feature';
    },
    getPortfolioItemTypePaths: function(){
        return _.pluck(this.portfolioItemTypeDefs, 'TypePath');
    },
    fetchPortfolioItemTypes: function(){
        return this.fetchWsapiRecords({
            model: 'TypeDefinition',
            fetch: ['TypePath', 'Ordinal','Name'],
            context: {workspace: this.getContext().getWorkspace()._ref},
            filters: [{
                property: 'Parent.Name',
                operator: '=',
                value: 'Portfolio Item'
            },
                {
                    property: 'Creatable',
                    operator: '=',
                    value: 'true'
                }],
            sorters: [{
                property: 'Ordinal',
                direction: 'ASC'
            }]
        });
    },
    fetchSnapshots: function(config){
        var deferred = Ext.create('Deft.Deferred');

        Ext.create('Rally.data.lookback.SnapshotStore', config).load({
            callback: function(snapshots, operation){
                if (operation.wasSuccessful()){
                    deferred.resolve(snapshots);
                } else {
                    deferred.reject('Failed to load snapshots: ', operation && operation.error && operation.error.errors.join(','))
                }
            }
        });

        return deferred;
    },
    getQueryFilter: function(){
        var query = this.getSetting('query');
        if (query && query.length > 0){
            this.logger.log('getQueryFilter', Rally.data.wsapi.Filter.fromQueryString(query));
            return Rally.data.wsapi.Filter.fromQueryString(query);
        }
        return [];
    },
    _buildGridboardStore: function(){
        this.logger.log('_buildGridboardStore');
        this.removeAll();

        Ext.create('Rally.data.wsapi.TreeStoreBuilder').build({
            models: this.getModelNames(),
            // autoLoad: true,
            enableHierarchy: true,
            fetch: [this.getFeatureName(),'ObjectID'],
            filters: this.getQueryFilter()
        }).then({
            success: this._addGridboard,
            failure: this.showErrorNotification,
            scope: this
        });
    },
    getModelNames: function(){
        return ['HierarchicalRequirement'];
    },
    getFeatureAncestorHash: function(){
        if (!this.featureAncestorHash){
            this.featureAncestorHash = {};
        }
        return this.featureAncestorHash;
    },
    setAncestors: function(records){
        var featureHash = this.getFeatureAncestorHash(),
            featureName = this.getFeatureName();

        for (var j=0; j<records.length; j++){
            var record = records[j],
                feature = record.get(featureName);
            if (feature){
                var objID = feature.ObjectID;
                var featureObj = featureHash[objID];
                for (var i=1; i<this.portfolioItemTypeDefs.length; i++){
                    var name = this.portfolioItemTypeDefs[i].TypePath.toLowerCase().replace('portfolioitem/','');

                    if (featureObj && featureObj[name]){
                        record.set(name, featureObj[name]);
                    } else {
                        record.set(name, null);
                    }
                }
            }
        }
    },

    updateFeatureHashWithWsapiRecords: function(results){

        var hash = {},
            features = [],
            featureTypePath = this.getPortfolioItemTypePaths()[0].toLowerCase(),
            ancestorNames = _.map(this.getPortfolioItemTypePaths(), function(pi){
                return pi.toLowerCase().replace('portfolioitem/','');
            });

        Ext.Array.each(results, function(res){
            Ext.Array.each(res, function(pi){
                hash[pi.get('ObjectID')] = pi.getData();
                if (pi.get('_type') === featureTypePath){
                    features.push(pi);
                }
            });
        });

        this.logger.log('updateFeatureHashWithWsapiRecords', ancestorNames, results);
        var featureHash = this.getFeatureAncestorHash();
        Ext.Array.each(features, function(s){

            var parent = s.get('Parent') && s.get('Parent').ObjectID || null,
                objID = s.get('ObjectID');

            if (!featureHash[objID]){
                featureHash[objID] = hash[objID];
                //initialize
                Ext.Array.each(ancestorNames, function(a){ featureHash[objID][a] = null; });
            }

            if (parent && featureHash[objID]){
                do {
                    var parentObj = hash[parent] || null,
                        parentName = hash[parent] && hash[parent]._type.replace('portfolioitem/','');

                    if (featureHash[objID]){
                        featureHash[objID][parentName] = parentObj;
                        parent = parentObj && parentObj.Parent && parentObj.Parent.ObjectID || null;
                    }
                } while (parent !== null);
            }
        });

    },
    fetchAncestors: function(featureOids){
        var deferred = Ext.create('Deft.Deferred');

        var promises = [];
        for (var i = 0; i< this.getPortfolioItemTypePaths().length; i++){
            var type = this.getPortfolioItemTypePaths()[i];

            var filterProperties = ['ObjectID'];

            for (var j=0; j<i; j++){
                filterProperties.unshift('Children');
            }

            var filterProperty = filterProperties.join('.');

            var filters = _.map(featureOids, function(f){
                return {
                    property: filterProperty,
                    value: f
                }
            });
            filters = Rally.data.wsapi.Filter.or(filters);
            this.logger.log('type', type, filters.toString());

            promises.push(this.fetchWsapiRecords({
                model: type,
                fetch: ['FormattedID','Name','Parent','ObjectID'],
                enablePostGet: true,
                limit: Infinity,
                pageSize: 1000,
                context: {project: null},
                filters: filters
            }));
        }
        this.setLoading('Loading Ancestor data...');
        Deft.Promise.all(promises).then({
            success: function(results){
                deferred.resolve(results);
            },
            failure: this.showErrorNotification,
            scope: this
        }).always(function(){ this.setLoading(false);},this);
        return deferred;


    },

    updateStories: function(store, node, records, operation){
        this.logger.log('updateStories',records, operation);

        if (records.length === 0 || records[0].get('_type') !== 'hierarchicalrequirement'){
            return;
        }
        var featureName = this.getFeatureName(),
            featureHash = this.getFeatureAncestorHash(),
            featureOids = [];

        Ext.Array.each(records, function(r){
            var feature = r.get(featureName);
            if (feature && !featureHash[feature.ObjectID]){
                if (!Ext.Array.contains(featureOids,feature.ObjectID)){
                    featureOids.push(feature.ObjectID);
                }
            }
        }, this);
        this.logger.log('featureOids', featureOids);

        if (featureOids.length > 0){
            this.fetchAncestors(featureOids).then({
                success: function(results){
                    this.updateFeatureHashWithWsapiRecords(results);
                    this.setAncestors(records);
                },
                failure: this.showErrorNotification,
                scope: this
            });
        } else {
            this.setAncestors(records)
        }
    },
    _addGridboard: function(store) {
        for (var i=1; i<this.portfolioItemTypeDefs.length; i++){
            var name =  this.portfolioItemTypeDefs[i].Name.toLowerCase();
            store.model.addField({name: name, type: 'auto', defaultValue: null});
        }
        store.on('load', this.updateStories, this);

        this.add({
            xtype: 'rallygridboard',
            context: this.getContext(),
            modelNames: this.getModelNames(),
            toggleState: 'grid',
            plugins: this.getGridPlugins(),
            stateful: false,
            gridConfig: {
                store: store,
                storeConfig: {
                    filters: this.getQueryFilter()
                },
                columnCfgs: this.getColumnConfigs(),
                derivedColumns: this.getDerivedColumns()
            },
            height: this.getHeight()
        });
    },
    getGridPlugins: function(){
        return [{
            ptype:'rallygridboardaddnew'
        },
            {
                ptype: 'rallygridboardfieldpicker',
                headerPosition: 'left',
                modelNames: this.getModelNames(),
                alwaysSelectedValues: [this.getFeatureName()],
                stateful: true,
                margin: '3 3 3 25',
                stateId: this.getContext().getScopedStateId('ancestor-columns-1')
            },{
                ptype: 'rallygridboardinlinefiltercontrol',
                inlineFilterButtonConfig: {
                    stateful: true,
                    stateId: this.getContext().getScopedStateId('ancestor-filters'),
                    modelNames: this.getModelNames(),
                    margin: 3,
                    inlineFilterPanelConfig: {
                        quickFilterPanelConfig: {
                            defaultFields: [
                                'ArtifactSearch',
                                'Owner',
                                'ModelType'
                            ]
                        },
                        advancedFilterPanelConfig: {
                            advancedFilterRowsConfig: {
                                flex: 2
                            }
                        }

                    }
                }
            }, {
                ptype: 'rallygridboardactionsmenu',
                menuItems: [
                    {
                        text: 'Export...',
                        handler: this._export,
                        scope: this
                    }
                ],
                buttonConfig: {
                    margin: 3,
                    iconCls: 'icon-export'
                }
            }];
    },
    getExportFilters: function(){
        var filters = this.getQueryFilter(),
            gridFilters = this.down('rallygridboard').currentCustomFilter.filters || [];

        if (filters.length > 0 && gridFilters.length > 0){
            filters = filters.and(gridFilters);
        } else {
            if (gridFilters.length > 0){
               filters = gridFilters;
            }
        }
        this.logger.log('getExportFilters', filters.toString());
        return filters;
    },
    updateExportStories: function(records){
        var deferred = Ext.create('Deft.Deferred');

        this.logger.log('updateExportStories',records);

        if (records.length === 0 || records[0].get('_type') !== 'hierarchicalrequirement'){
            deferred.resolve([]);
        }
        var featureName = this.getFeatureName(),
            featureHash = this.getFeatureAncestorHash(),
            featureOids = [];

        Ext.Array.each(records, function(r){
            var feature = r.get(featureName);
            if (feature && !featureHash[feature.ObjectID]){
                if (!Ext.Array.contains(featureOids,feature.ObjectID)){
                    featureOids.push(feature.ObjectID);
                }

            }
        }, this);
        this.logger.log('featureOids', featureOids);

        if (featureOids.length > 0) {
            this.fetchAncestors(featureOids).then({
                success: function (results) {
                    this.updateFeatureHashWithWsapiRecords(results);
                    this.setAncestors(records);
                    deferred.resolve(records);
                },
                failure: function (msg) {
                    deferred.reject(msg);
                },
                scope: this
            });
        }else {
            this.setAncestors(records);
            deferred.resolve(records);
        }

        return deferred;
    },
    _export: function() {

        var filters = this.getExportFilters();

        var columnCfgs = this.down('rallytreegrid').columns,
            additionalFields = _.filter(columnCfgs, function(c){ return c.text !== 'Rank' && (c.xtype === 'rallyfieldcolumn' || c.xtype === "treecolumn"); }),
            derivedFields = this.getDerivedColumns(),
            columns = Ext.Array.merge(additionalFields, derivedFields);

        var fetch = _.pluck(additionalFields, 'dataIndex');
        fetch.push('ObjectID');
        if (!Ext.Array.contains(fetch, this.getFeatureName())){
            fetch.push(this.getFeatureName());
        }
        this.setLoading('Loading data to export...');
        this.logger.log('columns', columnCfgs);
        this.fetchWsapiRecords({
            model: 'HierarchicalRequirement',
            fetch: fetch,
            filters: filters,
            limit: 'Infinity'
        }).then({
            success: this.updateExportStories,
            scope: this
        }).then({
            success: function(records){
                var csv = this.getExportCSV(records, columns);
                var filename = Ext.String.format("export-{0}.csv",Ext.Date.format(new Date(),"Y-m-d-h-i-s"));
                CArABU.technicalservices.FileUtilities.saveCSVToFile(csv, filename);
            },
            failure: this.showErrorNotification,
            scope: this
        }).always(function(){ this.setLoading(false); }, this);
    },
    getExportCSV: function(records, columns){
        var standardColumns = _.filter(columns, function(c){ return c.dataIndex || null; }),
            headers = _.map(standardColumns, function(c){ if (c.text === "ID") {return "Formatted ID"; } return c.text; }),
            fetchList = _.map(standardColumns, function(c){ return c.dataIndex; }),
            derivedColumns = this.getDerivedColumns();

        this.logger.log('getExportCSV', headers, fetchList);

        Ext.Array.each(derivedColumns, function(d){
            headers.push(d.text);
        });

        var csv = [headers.join(',')];

        for (var i = 0; i < records.length; i++){
            var row = [],
                record = records[i];

            for (var j = 0; j < fetchList.length; j++){
                var val = record.get(fetchList[j]);
                if (Ext.isObject(val)){
                    val = val._refObjectName;
                }
                row.push(val || "");
            }

            Ext.Array.each(derivedColumns, function(d){
                var ancestor = record.get(d.ancestorName);
                if (ancestor){
                    row.push(Ext.String.format("{0}: {1}", ancestor.FormattedID, ancestor.Name));
                } else {
                    row.push("");
                }
            });

            row = _.map(row, function(v){ return Ext.String.format("\"{0}\"", v.toString().replace(/"/g, "\"\""));});
            csv.push(row.join(","));
        }
        return csv.join("\r\n");
    },

    getColumnConfigs: function(){
        var cols = [{
            dataIndex: 'Name',
            text: 'Name'
        },{
            dataIndex: 'ScheduleState',
            text: 'Schedule State'
        },{
            dataIndex: this.getFeatureName(),
            text: this.getFeatureName()
        }].concat(this.getDerivedColumns());
        this.logger.log('cols', cols);
        return cols;
    },
    getDerivedColumns: function(){
        var cols = [];
        //Ext.Array.each(this.portfolioItemTypeDefs, function(p){
        for (var i = 1; i< this.portfolioItemTypeDefs.length; i++){

            var name = this.portfolioItemTypeDefs[i].TypePath.toLowerCase().replace('portfolioitem/','');

            cols.push({
               // dataIndex: name,
                ancestorName: name,
                xtype: 'ancestortemplatecolumn',
                text: this.portfolioItemTypeDefs[i].Name
            });
        }

        return cols;
    },
    fetchWsapiRecords: function(config){
        var deferred = Ext.create('Deft.Deferred');
        Ext.create('Rally.data.wsapi.Store',config).load({
            callback: function(records, operation){
                if (operation.wasSuccessful()){
                    deferred.resolve(records);
                } else {
                    deferred.reject(Ext.String.format('Failed to fetch {0} records: {1}',config.model ,operation && operation.error && operation.error.errors.join(',')));
                }
            }
        });
        return deferred;
    },
    
    getOptions: function() {
        return [
            {
                text: 'About...',
                handler: this._launchInfo,
                scope: this
            }
        ];
    },
    getSettingsFields: function(){
        return [{
            xtype: 'textarea',
            fieldLabel: 'Query Filter',
            name: 'query',
            anchor: '100%',
            cls: 'query-field',
            margin: '0 70 0 0',
            labelAlign: 'right',
            labelWidth: 100,
            plugins: [
                {
                    ptype: 'rallyhelpfield',
                    helpId: 194
                },
                'rallyfieldvalidationui'
            ],
            validateOnBlur: false,
            validateOnChange: false,
            validator: function(value) {
                try {
                    if (value) {
                        Rally.data.wsapi.Filter.fromQueryString(value);
                    }
                    return true;
                } catch (e) {
                    return e.message;
                }
            }
        }];
    },
    _launchInfo: function() {
        if ( this.about_dialog ) { this.about_dialog.destroy(); }
        this.about_dialog = Ext.create('Rally.technicalservices.InfoLink',{});
    },
    
    isExternal: function(){
        return typeof(this.getAppId()) == 'undefined';
    },
    
    //onSettingsUpdate:  Override
    onSettingsUpdate: function (settings){
        this.logger.log('onSettingsUpdate',settings);
        // Ext.apply(this, settings);
        this._buildGridboardStore();
    }
});

            
               Rally.launchApp('user-story-ancestor-grid', {
                   name: 'User Story Ancestor Grid'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>